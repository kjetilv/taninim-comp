{"version":3,"sources":["taninim/api.cljs"],"mappings":"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","names":["taninim.api/parse-jsonl","text","clojure.string.split","cljs.core.remove","clojure.string/blank?","p1__12586#","cljs.core.mapv","cljs.core.js__GT_clj","js/JSON","taninim.api/yellin-base","taninim.api/kudu-base","re_frame.core.reg_event_fx","p__12587","p__12588","map__12589","cljs.core/--destructure-map","cljs.core.get","vec__12590","cljs.core.nth","db","_","ext-auth-response","ajax.core/json-request-format","ajax.core/json-response-format","p__12593","map__12594","token","cljs.core.get_in","ajax.core/text-response-format","p__12595","vec__12596","response","p__12599","p__12600","map__12601","vec__12602","album-id","map__12605","user-id","p__12606","p__12607","map__12608","vec__12609","map__12612","taninim.api/audio-url","track-uuid","format","cljs.core/name"],"sourcesContent":["(ns taninim.api\n  (:require [ajax.core :as ajax]\n            [clojure.string :as str]\n            [re-frame.core :as rf]))\n\n(defn- parse-jsonl [text]\n  (->> (str/split text #\"\\n\")\n       (remove str/blank?)\n       (mapv #(js->clj (.parse js/JSON %) :keywordize-keys true))))\n\n(def ^:private yellin-base \"http://localhost:8081\")\n(def ^:private kudu-base \"http://localhost:8082\")\n\n(rf/reg-event-fx\n  :api/authenticate\n  (fn [{:keys [db]} [_ ext-auth-response]]\n    {:http-xhrio {:method          :post\n                  :uri             (str yellin-base \"/auth\")\n                  :params          ext-auth-response\n                  :format          (ajax/json-request-format)\n                  :response-format (ajax/json-response-format {:keywords? true})\n                  :on-success      [:auth/success]\n                  :on-failure      [:auth/failure]}}))\n\n(rf/reg-event-fx\n  :api/fetch-library\n  (fn [{:keys [db]} _]\n    (let [token (get-in db [:auth :token])]\n      {:http-xhrio {:method          :get\n                    :uri             (str kudu-base \"/library.jsonl\")\n                    :params          {:t token}\n                    :response-format (ajax/text-response-format)\n                    :on-success      [:api/library-fetched]\n                    :on-failure      [:library/fetch-failed]}})))\n\n(rf/reg-event-fx\n  :api/library-fetched\n  (fn [_ [_ response]]\n    {:fx [[:dispatch [:library/loaded (parse-jsonl response)]]]}))\n\n(rf/reg-event-fx\n  :api/acquire-lease\n  (fn [{:keys [db]} [_ album-id]]\n    (let [{:keys [user-id token]} (:auth db)]\n      {:http-xhrio {:method          :post\n                    :uri             (str yellin-base \"/lease\")\n                    :params          {:userId user-id :token token :album album-id}\n                    :format          (ajax/json-request-format)\n                    :response-format (ajax/json-response-format {:keywords? true})\n                    :on-success      [:lease/acquired album-id]\n                    :on-failure      [:lease/acquire-failed album-id]}})))\n\n(rf/reg-event-fx\n  :api/release-lease\n  (fn [{:keys [db]} [_ album-id]]\n    (let [{:keys [user-id token]} (:auth db)]\n      {:http-xhrio {:method          :delete\n                    :uri             (str yellin-base \"/lease\")\n                    :params          {:userId user-id :token token :album album-id}\n                    :response-format (ajax/json-response-format {:keywords? true})\n                    :on-success      [:lease/released album-id]\n                    :on-failure      [:lease/release-failed album-id]}})))\n\n(defn audio-url [track-uuid format token]\n  (str kudu-base \"/audio/\" track-uuid \".\" (name format) \"?t=\" token))\n"]}